---
title: "Spinvis project"
author: "Anna Sas"
date: "2024-02-23"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# loading libraries
library(tidyverse)
library(spotifyr)
library(flexdashboard)
library(plotly)
library(Cairo)
library(compmus)
library(patchwork)
library(gridExtra)
library(dplyr)
library(futile.logger)
library(VennDiagram)
library(tidymodels)
library(ggdendro)
library(heatmaply)
```

```{r}
get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit |> 
    collect_predictions() |> 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit |> 
    conf_mat_resampled() |> 
    group_by(Prediction) |> mutate(precision = Freq / sum(Freq)) |> 
    group_by(Truth) |> mutate(recall = Freq / sum(Freq)) |> 
    ungroup() |> filter(Prediction == Truth) |> 
    select(class = Prediction, precision, recall)
}  


```

```{r}
spinvisproject <-
  get_playlist_audio_features("Spinvisproject", "1005SKXxknjHvBI2qBoYRP") |>
  add_audio_analysis() |>
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  mutate_at(vars(pitches, timbre), map, bind_rows) |>
  unnest(cols = c(pitches, timbre))


genre <-
  get_playlist_audio_features("Spinvisprojectgenre", "6STbsnrajWWZnnnWxqoFFv") |>
  add_audio_analysis() |>
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  mutate_at(vars(pitches, timbre), map, bind_rows) |>
  unnest(cols = c(pitches, timbre))


```

```{r}
spinvisproject1 <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration,
    data = spinvisproject
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(spinvisproject |> mutate(track.name = str_trunc(track.name, 20))) |>
  juice() |>
  column_to_rownames("track.name")


genre1 <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration,
    data = genre
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(genre |> mutate(track.name = str_trunc(track.name, 20))) |>
  juice() |>
  column_to_rownames("track.name")


spinvisproject_dist <- dist(spinvisproject1, method = "euclidean")
genre_dist <- dist(genre1, method = "euclidean")
``` 

```{r}
spinvisproject_dist |> 
  hclust(method = "average") |> # Try single, average, and complete.
  dendro_data() |>
  ggdendrogram()

genre_dist |> 
  hclust(method = "average") |> # Try single, average, and complete.
  dendro_data() |>
  ggdendrogram()

```

### Heatmap

```{r}
heatmaply(
  spinvisproject1,
  hclustfun = hclust,
  hclust_method = "average",  # Change for single, average, or complete linkage.
  dist_method = "euclidean"
)


heatmaply(
  genre1,
  hclustfun = hclust,
  hclust_method = "average",  # Change for single, average, or complete linkage.
  dist_method = "euclidean"
)


```



### Background

Spinvis (Erik de Jong) is a Dutch artist, who’s music is hard to categorize in a specific genre. Some even say that Spinvis is his own genre, but his music comes most close to the genres, experimental Lo-Fi, experimental pop, neo-psychedelia, alternative indie and even a bit of modern dance and electronics. The music is composed through sampling and cutting of pieces of different sounds, varying from sound samples from computers and sounds made by differing attributes, such as pot lids, a whistle and a keyboard. The texts of the songs cohere with the sounds and are almost poetic and supported by the melancholic voice of Erik. The first album, “Spinvis (2002)”, is the most alternative and makes mainly use of computer based sampling, attributes and sensational song texts. From his third album on, “Dagen van Gras, Dagen Van Stro (2005)”, he is accompanied by his band. 
The corpus that will be studied is the Corpus of different songs of Spinvis. Sampling different songs of every album made by Spinvis and sampling different songs in the coherent genres. This to try to distinguish what specific aspects of Spinvis can be heard in the different genres. I expect to that many aspects of the style of Spinvis can be found in many different genres, because it is hard to assign him to one specific genre. 

***


### How similar are the features in Spinvis songs compared to different genres
```{r include=FALSE}
spinvis <- get_artist_audio_features('spinvis')
tracks_spinvis_project <- get_playlist_tracks("1005SKXxknjHvBI2qBoYRP")
playlist_spinvis_project <- get_playlist_audio_features("", "1005SKXxknjHvBI2qBoYRP")

track_spinvis_project_genre <- get_playlist_tracks("6STbsnrajWWZnnnWxqoFFv")
playlist_spinvis_project_genre <- get_playlist_audio_features("","6STbsnrajWWZnnnWxqoFFv")
```

```{r include=FALSE}
spinvis_project <- rbind(playlist_spinvis_project |> mutate(category = "Spinvis"),playlist_spinvis_project_genre |> mutate(category = "Genre"))

```

```{r echo=FALSE}
spinvis_project1 <- data.frame(Feature = c("Danceability", "Energy", "Speechiness", "Acousticness", "Liveness", "Valence"),
  Value = c(spinvis_project$danceability,spinvis_project$energy, spinvis_project$speechiness,spinvis_project$acousticness,spinvis_project$liveness,spinvis_project$valence), Category = c(spinvis_project$playlist_name)  
) 

spinvis_project1 |>
  ggplot(aes(x = Value, y = Feature, colour = Category)) +
  geom_point(alpha = 0.8) +
  scale_color_viridis_d() +
  labs(
    x = "Value",
    y = "Feature",
    colour = "Category"
  )


#boxplot
spinvis_project <- rbind(playlist_spinvis_project |> mutate(category = "Spinvis"),playlist_spinvis_project_genre |> mutate(category = "Genre"))

spinvis_project <- data.frame(Feature = c("Danceability", "Energy", "Speechiness", "Acousticness", "Liveness", "Valence"),
  Value = c(spinvis_project$danceability,spinvis_project$energy, spinvis_project$speechiness,spinvis_project$acousticness,spinvis_project$liveness,spinvis_project$valence), Category = c(spinvis_project$playlist_name)  
)

spinvisplot <- ggplot(spinvis_project, aes(x = Feature, y = Value, fill = Category)) +
  geom_boxplot() +
  labs(fill = "Category") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


plot(spinvisplot)
```

***
The two playlist that are compared in both graphs are a Spinvis playlist, only containing songs of Spinvis (Category: Spinvis project) and a playlist with songs that are in overlapping genres with spinvis (Category: Spinvis project genre). Both graphs show the measured features and belonging values.
The first plot shows a bargraph in which little differences can be found. The biggest difference can be seen between the categories and features of 'Liveness' and 'Valence'. Meaning that the songs of Spinvis are less featuring liveness compared to overlapping genres, but are more featuring valence. 


In addition a second graph was plotted. Given that the playlist of only spinvis songs is compared to a playlist of several songs that all are from different genres overlapping with spinvis. Meaning that it is interesting to look at also the means and how these fluctuate and show very different results. 
Both for spinvis as for the category genre, both have many outliers fluctuating eatheir down or up. For valence you can see that both the maximum as the minimum in both categories is the same but the mean is much different. 

### Cepstrograms

```{r include = FALSE}
#making a chomagram 'Picasso'
Picasso <-
  get_tidy_audio_analysis("7uZmEzoizrwl8KVFCWBSv1") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

IkAdemDoorMijnOgen <- get_tidy_audio_analysis("2fHyR5RQfGvJMlfFW96faZ") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

```

```{r echo=FALSE}

Picasso |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, title = "Picasso (7.6.9.6.)", fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

IkAdemDoorMijnOgen |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, title = "Ik Adem Door Mijn Ogen (Goochelaars & Geesten)", fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

```

*** 
chromogram of the song Picasso (album: 7.6.9.6). 


### Dynamic Time Wrapping

```{r echo=FALSE}
#Dynamic Time Wrapping of both songs Kom Terug but different albums
KomTerug_2011 <- get_tidy_audio_analysis("4ovxUTMs3Mi7ntZS2tJojk") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)
  
KomTerug_2017 <-
  get_tidy_audio_analysis("5EiOs7I8fX402shgQCWBSf") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

compmus_long_distance(
  KomTerug_2011 |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  KomTerug_2017 |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) |>
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = 2011, y = 2017, title = "'Kom Terug' different albums") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

### Tweede kamer (genre) en Paradijs (spinvis)
#Dynamic Time Wrapping of both songs Kom Terug but different albums
TweedeKamer <- get_tidy_audio_analysis("6o1Uv8FqaVBtqCXmjrCbSA") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)
  
Paradijs <-
  get_tidy_audio_analysis("2mbXlUgTv5fdWwfxVUoqn5") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

compmus_long_distance(
  Paradijs |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  TweedeKamer |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) |>
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Paradijs", y = "Tweede Kamer", title = "How similar are Tweede Kamer & Paradijs") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)


```

***
The song Kom Terug can be found on different albums of Spinvis. A version of 
Both songs paradijs and tweede kamer 


### Cepstrogram

```{r include=FALSE}
#part 1
Picasso <-
  get_tidy_audio_analysis("7uZmEzoizrwl8KVFCWBSv1") |> # Change URI.
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

#Alles is
Picasso <-
  get_tidy_audio_analysis("7uZmEzoizrwl8KVFCWBSv1") |> # Change URI.
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )
```

```{r echo=FALSE}
#part 2
Picasso |>
  compmus_gather_timbre() |>
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Picasso (7.6.9.6.)") +
  scale_fill_viridis_c() +                              
  theme_classic()

```
***

### Self-Similarity Matrices

```{r echo=FALSE}
PicassoTimbre <- Picasso |>
  compmus_self_similarity(timbre, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title = "Timbre")

## picasso

PicassoPitches <- Picasso |>
  compmus_self_similarity(pitches, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title =  "Pitches")
plot(PicassoPitches)
plot(PicassoTimbre)

```

***
Picasso song

### Chordograms

```{r include=FALSE}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )


```

```{r echo=FALSE}
VoorIkVergeet <-
  get_tidy_audio_analysis("5lQozZo5ESEJ1g2cWjetba") |>
  compmus_align(sections, segments) |>
  select(sections) |>
  unnest(sections) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )
 
VoorIkVergeet|> 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) |>
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Voor Ik Vergeet (Spinvis)")



HemelValt <-
  get_tidy_audio_analysis("2d0amOy3Pd3Y88EwAtBlj2") |>
  compmus_align(sections, segments) |>
  select(sections) |>
  unnest(sections) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

HemelValt |> 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) |>
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Hemel Valt (Typhoon)")

LetItHappen <-
  get_tidy_audio_analysis("2X485T9Z5Ly0xyaghN73ed") |>
  compmus_align(sections, segments) |>
  select(sections) |>
  unnest(sections) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

LetItHappen |> 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) |>
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Let It Happen (Tame Impala)")

```

***
The songs that are seen in the Chordograms are:
Voor Ik Vergeet (Spinvis)
https://open.spotify.com/track/5lQozZo5ESEJ1g2cWjetba?si=3fb29402ab104c44

Hemel Valt (Typhoon)
https://open.spotify.com/track/2d0amOy3Pd3Y88EwAtBlj2?si=25992426e015493a

Let It Happen (Tame Impala)
https://open.spotify.com/track/2X485T9Z5Ly0xyaghN73ed?si=77597afa17224287

What can be seen is the song of
Spinvis shows a less clear pattern, and spotify seems to think that the song have come to an end at 220 sec. Also spinvis sound is mostly in c# minor, Ab Major and Db Major.
Typhoon has a very clear pattern in his song and is mostly in the keys F Major and F Minor
Tame Impala has a less clear pattern, around 100 sec is a small decrease. Around 250 sec till 300 sec there is also a moment spotify is not sure how to analyse. In the song (starting from 3:50) there is a soundsequence that is probably hard to analyse for spotify, given the big yellow part. Furthermore it is hard to say in which specific key the song is played.  




### Tempogram

```{r, include=FALSE}
Ronnie <- get_tidy_audio_analysis("53BEvoEYpcQ7418Ed4VMtg")

```

```{r, echo=FALSE}
Ronnie |>
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) |>
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()

Ronnie |>
  tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) |>
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()

```
*** 
A Fourier-based tempogram of the song "Ronnie knipt zijn Haar (album: tot ziens, Justine Keller) is shown. An attempt to analyse the tempo of the song is made, by using Spotify's API. An estimation made by Spotify is a tempo of 80 BPM. In some freer-form sections of the piece, tempo estimation is almost impossible.

Ronnie knipt zijn Haar
https://open.spotify.com/track/53BEvoEYpcQ7418Ed4VMtg?si=bb042e3bc0f24441


### Novelty function

```{r echo=FALSE}
Ronnie <-
  get_tidy_audio_analysis("53BEvoEYpcQ7418Ed4VMtg") |>
  select(segments) |>
  unnest(segments)

Ronnie |>
  mutate(loudness_max_time = start + loudness_max_time) |>
  arrange(loudness_max_time) |>
  mutate(delta_loudness = loudness_max - lag(loudness_max)) |>
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")

```








```{r include=FALSE}
Ronnie |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  arrange(start) |>
  mutate(pitches = map2(pitches, lag(pitches), `-`)) |>
  slice(-1) |> 
  compmus_gather_chroma() |> 
  group_by(start, duration) |> 
  summarise(novelty = sum(log1p(pmax(value, 0)))) |> 
  ggplot(aes(x = start + duration / 2, y = novelty)) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")



Ronnie |>
  arrange(start) |>
  mutate(timbre = map2(timbre, lag(timbre), `-`)) |>
  slice(-1) |>
  compmus_gather_timbre() |>
  group_by(start, duration) |> 
  summarise(novelty = sum(log1p(pmax(value, 0)))) |> 
  ggplot(aes(x = start + duration / 2, y = novelty)) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")

``` 

### Conclusion

weaknesses of the corpus:
strengths of the corpus:
interesting results overview:
discussion/conclusion:

***

### uitbroberen

```{r}
project <- get_playlist_audio_features("spotify", "1005SKXxknjHvBI2qBoYRP")
genreproject <- get_playlist_audio_features("spotify", "6STbsnrajWWZnnnWxqoFFv")
vergelijking <-
  bind_rows(
    project |> mutate(playlist = "Spinvis project") |> slice_head(n = 20),
    genreproject |> mutate(playlist = "Spinvis project genre") |> slice_head(n = 20)
  ) |> 
  add_audio_analysis()


```

```{r}
vergelijking_features <-
  vergelijking |>  # For your portfolio, change this to the name of your corpus.
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  mutate_at(vars(pitches, timbre), map, bind_rows) |>
  unnest(cols = c(pitches, timbre))


```

```{r}
vergelijking_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration,
    data = vergelijking_features           # Use the same name as the previous block.
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())  

vergelijking_cv <- vergelijking_features |> vfold_cv(5)
```

```{r}
knn_model <-
  nearest_neighbor(neighbors = 1) |>
  set_mode("classification") |> 
  set_engine("kknn")
vergelijking_knn <- 
  workflow() |> 
  add_recipe(vergelijking_recipe) |> 
  add_model(knn_model) |> 
  fit_resamples(vergelijking_cv, control = control_resamples(save_pred = TRUE))

vergelijking_knn |> get_conf_mat()

vergelijking_knn |> get_conf_mat() |> autoplot(type = "mosaic")

vergelijking_knn |> get_conf_mat() |> autoplot(type = "heatmap")
```

```{r}
vergelijking_knn |> get_pr()
```

```{r}
forest_model <-
  rand_forest() |>
  set_mode("classification") |> 
  set_engine("ranger", importance = "impurity")
vergelijking_forest <- 
  workflow() |> 
  add_recipe(vergelijking_recipe) |> 
  add_model(forest_model) |> 
  fit_resamples(
    vergelijking_cv, 
    control = control_resamples(save_pred = TRUE)
  )

vergelijking_forest |> get_pr()
```
```{r}
workflow() |> 
  add_recipe(vergelijking_recipe) |> 
  add_model(forest_model) |> 
  fit(vergelijking_features) |> 
  pluck("fit", "fit", "fit") |>
  ranger::importance() |> 
  enframe() |> 
  mutate(name = fct_reorder(name, value)) |> 
  ggplot(aes(name, value)) + 
  geom_col() + 
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Importance")



```

```{r}
vergelijking_features |>
  ggplot(aes(x = acousticness, y = c02, colour = playlist, size = energy)) +
  geom_point(alpha = 0.8) +
  scale_color_viridis_d() +
  labs(
    x = "Acousticness",
    y = "Timbre Component 2",
    size = "Energy",
    colour = "Playlist"
  )

```

...
